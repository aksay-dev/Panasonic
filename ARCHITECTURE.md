# Архитектура системы декодирования данных теплового насоса

## Общая схема

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Heat Pump     │    │   Protocol      │    │    Decoder      │
│   Panasonic     │◄──►│   Module        │◄──►│    Module       │
│   Aquarea       │    │   (protocol.c)  │    │  (decoder.c)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   UART          │    │  Decoded Data   │
                       │   Communication │    │  Structure      │
                       │   (9600 baud)   │    │ (hp_decoder_    │
                       └─────────────────┘    │  data_t)        │
                                              └─────────────────┘
```

## Поток данных

```
1. Heat Pump → UART → Protocol Module
2. Protocol Module → Data Validation → Decoder Module
3. Decoder Module → Data Decoding → Structured Data
4. Structured Data → Logging/Processing
```

## Модули системы

### 1. Protocol Module (protocol.c/h)
- **Назначение**: Коммуникация с тепловым насосом через UART
- **Функции**:
  - Инициализация UART (9600 baud, 8N1, Even parity)
  - Отправка команд запроса данных
  - Получение и валидация ответов
  - Проверка контрольных сумм
  - Передача данных в Decoder Module

### 2. Decoder Module (decoder.c/h)
- **Назначение**: Декодирование сырых данных в структурированную информацию
- **Функции**:
  - Декодирование основных данных (203 байта, 139 топиков)
  - Декодирование дополнительных данных (110 байт, 6 топиков)
  - Декодирование опциональных данных (20 байт, 7 топиков)
  - Преобразование байтов в физические величины
  - Предоставление API для доступа к данным

### 3. Main Application (hpc.c/h)
- **Назначение**: Основное приложение, координирующее работу модулей
- **Функции**:
  - Инициализация всех модулей
  - Запуск задач
  - Тестирование функциональности

## Типы данных

### Main Data (Основные данные)
- **Размер**: 203 байта
- **Топики**: 139 (TOP0-TOP138)
- **Содержание**:
  - Температуры (вход, выход, наружная, ГВС, зоны)
  - Мощности (производство/потребление тепла, холода, ГВС)
  - Состояния (режимы работы, насосы, клапаны)
  - Настройки (кривые нагрева/охлаждения, дельты)
  - Информация об ошибках и модели

### Extra Data (Дополнительные данные)
- **Размер**: 110 байт
- **Топики**: 6 (XTOP0-XTOP5)
- **Содержание**:
  - Дополнительные данные о потреблении энергии
  - Дополнительные данные о производстве энергии

### Optional Data (Опциональные данные)
- **Размер**: 20 байт
- **Топики**: 7 (OPT0-OPT6)
- **Содержание**:
  - Состояния насосов зон
  - Состояния смесительных клапанов
  - Состояние аварийной сигнализации

## Функции декодирования

### Базовые функции преобразования
- `getIntMinus128()` - преобразование с вычитанием 128
- `getIntMinus1()` - преобразование с вычитанием 1
- `getPower()` - преобразование в мощность (×200W)
- `getOpMode()` - декодирование режима работы
- `getBit1and2()`, `getBit3and4()` и т.д. - извлечение битовых полей

### Специальные функции
- `getPumpFlow()` - расчет потока насоса
- `getErrorInfo()` - декодирование информации об ошибках
- `getModel()` - получение модели теплового насоса
- `getValvePID()` - PID настройки клапанов

## Интеграция с HeishaMon

Система полностью совместима с протоколом HeishaMon:
- Использует те же адреса байтов для топиков
- Применяет те же алгоритмы декодирования
- Поддерживает все 139 основных топиков
- Включает все описания и единицы измерения

## Расширяемость

Архитектура позволяет легко:
- Добавлять новые топики данных
- Модифицировать алгоритмы декодирования
- Интегрировать с другими системами (MQTT, HTTP API)
- Добавлять новые типы данных от теплового насоса
